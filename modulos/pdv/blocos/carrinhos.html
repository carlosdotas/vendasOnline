<script type="text/javascript" src="modulos/pdv/classes/classCarrinho.js"></script>
<div id="blockCarrinhos"></div>
<script type="text/javascript">
//$( document ).ready(function() {



	/*-----------------------------------------------------------------*/
	const carrinhos = new Carrinho({
		fit:true,
		onCreate:function(params){
			$('#blockCarrinhos').tabs(params);
		},
		onSet:function(params){	

			//let NunTotalVendas = totalVendas();
			params.title='Venda: <b>'+params.id+'</b>';
			//params.id = '_'+NunTotalVendas;

			//carrinhos.list[params.id] = {produtos:{}};

			/*-----------------------------------------------------------------*/			
			$('#blockCarrinhos').tabs('add',params);	

			/*-----------------------------------------------------------------*/
			$('#'+params.id).layout({fit:true});

			/*-----------------------------------------------------------------*/
			$('#'+params.id).layout('add',{//Gera Contedudo de Produtos
			    region: 'center',			    
			    border:0,
			   // title:'Venda:'+params.id,
			    content:`<div id="list_${params.id}"></div>`
			});
		

			//Gera Tabela de Produtos
			/*-----------------------------------------------------------------*/
			$(`#list_${params.id}`).datagrid({
			    border:0,
			    singleSelect:true,
			    fitColumns:true,
			    pagination:true,
			    fit:true,
			    pageSize:20,
			    columns:[[

			        {
			        	field:'imgsSelected',
			        	title:'#',
			        	align:'center',
			        	width:55,
			        	formatter: function(value,row,index){
							return `<img src="${value}" width="55" height="55">`;
						}
			        },
			        {
			        	field:'produto',
			        	title:'Produto',
			        	width:250,
			        	formatter: function(value,row,index){
							return `
							<b style="font-size: 14px;">${row.produto}</b>
							<div> Codigo: <span style="color:blue">${row.cod}</span></div>
							<div style="font-size: 14px;">Pre√ßo: <b style="color:red">R$ ${row.preco}</b> X ${row.qnt} = <b style="color:red">R$ ${row.total}</b></div>
							`;
						}
			        }
			    ]],
			    onSelect:function(index,row){
			    	carrinhos.selectProduto(row);
			    }
			});

			$('#'+params.id).layout('add',{//Gera Conteudo de Carrinhos
			    width: 200,
			    title: 'Pagamento',
			    region: 'east',
			    border:0,
			    bodyCls:'blockProdutos pdg5',
			    content:`<span>Valor Total:</span>
			    	<input name="total" >
			    	<span>Valor Pago:</span>
			    	<input name="pago" >
			    	<span>Valor Troco:</span>
			    	<input name="troco" >
			    	<span>Cliente:</span>
			    	<input name="cliente" >
			    	<span>Detalhes:</span>
			    	<input name="detalhe" >`});


		},
		onSelect:function(value,index,value2){
	    	carrinhos.selected = $('#blockCarrinhos').tabs('getSelected').attr('id');
	    	//console.log(carrinhos.selected)
	    },
	    onSetCarrinho:function(){
			//Seta produto na Grid
			//---------------------------------------------------------------------//
			$(`#list_${carrinhos.selected}`).datagrid({
				data:(carrinhos.getCarrinho())
			});	    	
	    }
	});

	/*-----------------------------------------------------------------*/
	carrinhos.set({//Gera Contedudo de Produtos
	    id:totalVendas(),
	    closable:true,
	    produtos:[]	    
	    //href:`modulos/pdv/blocos/carrinho.html`,
	});


//Regras de Negocios do Filtro de Busca
/*-----------------------------------------------------------------*/
$('#buscaPorCodigo').select();
$('#buscaPorCodigo').buscar({

	//Filtra Produto
	/*-----------------------------------------------------------------*/
	onkeyup:function(dados){
		//cl(dados);
		//$('#listaDeProdutos').datalist('unselectAll');

		if(dados.type=='cod'){
			$('#listaDeProdutos').datagrid({
				url:'server.php?json=produtos&cod='+dados.val
			});						
		}

		if(dados.type=='text' && dados.tecla!='Enter'){
			$('#listaDeProdutos').datagrid({
				url:'server.php?json=produtos&produto='+dados.val,
				onLoadSuccess:function(){
					window.listSelected = '#listaDeProdutos';
					$('#listaDeProdutos').datalist('selectRow',0);
				}
			});						
		}

		if(dados.type=='money'){
			$('#listaDeProdutos').datalist('unselectAll');					
		}

		if(dados.type=='limpo'){
			$('#listaDeProdutos').datagrid({
				url:'server.php?json=produtos',
				onLoadSuccess:function(){

					$('#listaDeProdutos').datalist('unselectAll');
				}
			});	
						
		}									
	},
	//Envia Produto
	/*-----------------------------------------------------------------*/
	onSend:function(dados){		


		//Cerifica Linha Selecionada
		//---------------------------------------------------------------------//
		var getSelected = $('#listaDeProdutos').datalist('getSelected');
		var getRowIndex = $('#listaDeProdutos').datalist('getRowIndex',getSelected);

		if(getRowIndex>=0){
			dados.type="cod";
			dados.val=getSelected.cod;
		}

		if(dados.tecla=='Enter'){
			//$('#listaDeProdutos').datagrid({
			//	url:'server.php?json=produtos',
			//	onLoadSuccess:function(){
			//		$('#listaDeProdutos').datalist('unselectAll');
			//	}
			//});	
		}

		let produto = {};

		//console.log(dados);

		//Regra de Negocio de Entrada no Carrinho
		//---------------------------------------------------------------------//

		if(dados.type=="cod"){
			let server = getJSON('server.php?json=produtos&cod='+dados.val)['rows'][0];
			produto.preco = server.preco;
			produto.produto = server.produto;
			produto.cod = server.cod;

		}

		if(dados.type=="money"){
			produto.preco = dados.val;
			produto.produto = 'Produto Avulso';
			produto.cod = getCodTimer();
		}

		if(dados.type=="negative"){
			produto.preco = dados.val;
			produto.produto = 'Pagamento';
			produto.cod = getCodTimer();
		}
		
		if(dados.type=="limpo"){
			produto = carrinhos.getselectProduto();
		}		

		if(produto.cod){
			
			//Adiciona Produto no Crrinho
			//---------------------------------------------------------------------//
			carrinhos.setCarrinho(produto);
			window.listSelected = `#list_${carrinhos.selected}`;
			$(window.listSelected).datagrid('selectRow',0);	

		}
	}		
})




//});
</script>