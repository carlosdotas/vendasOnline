<script type="text/javascript" src="modulos/pdv/classTabs.CarrinhoEasyui.js"></script>
<div id="blockCarrinhos"></div>
<script type="text/javascript">
//$( document ).ready(function() {


//Cria Tabs de  Carrinhos
//----------------------------------------------------------//
const tabsDeCarrinho = new tabsCarrinhosEasyui({
	element:'#blockCarrinhos',
	columns:[
        {field:'cod',title:'Codigo',width:0},
        {field:'name',title:'Nome',width:100},
        {field:'preco',title:'Preco',align:'right'},
        {field:'qnt',title:'Qnt',align:'center'},
        {field:'total',title:'Total',align:'right'},
    ]
})
//----------------------------------------------------------//
tabsDeCarrinho.addAba(totalVendas());


//Regras de Negocios do Filtro de Busca
$('#buscaPorCodigo').select();
$('#buscaPorCodigo').buscar({

	//Filtra Produto ao Digitar Teclas
	onkeyup:function(dados){
		//cl(dados);
		//$('#listaDeProdutos').datalist('unselectAll');

		if(dados.sizer<=1)return false;
		


		if(dados.type=='money'){
			$(window.listSelected).datalist('unselectAll');					
		}

		if(dados.type=="negative"){
			$(window.listSelected).datalist('unselectAll');	
		}

		if(dados.type=='limpo'){
			$('#listaDeProdutos').datagrid({
				url:'server.php?json=produtos',
				onLoadSuccess:function(){
					$(window.listSelected).datalist('unselectAll');
				}
			});							
		}			

		$().Deley(function(){

			if(dados.type=='cod'){
				$('#listaDeProdutos').datagrid({
					url:'server.php?json=produtos&cod='+dados.val
				});						
			}
		
			if(dados.type=='text' && dados.tecla!='Enter'){
				$('#listaDeProdutos').datagrid({
					url:'server.php?json=produtos&produto='+dados.val,
					onLoadSuccess:function(){
						window.listSelected = '#listaDeProdutos';
						//$('#listaDeProdutos').datalist('selectRow',0);
					}
				});						
			}

		});								
	},
	
	//Envia Produto
	onSend:function(dados){		

		//Verificador de vendas Existentes
		//---------------------------------------------------------------------//


		//Cerifica Linha Selecionada
		//---------------------------------------------------------------------//



		let produto = {};

		//console.log(dados);

		//Regra de Negocio de Entrada no Carrinho
		//---------------------------------------------------------------------//
		var getSelected = $(window.listSelected).datalist('getSelected');
		var getRowIndex = $(window.listSelected).datalist('getRowIndex',getSelected);

		if(
			getRowIndex>=0 && dados.type!="cod"){
			dados.type="select";
			produto = getSelected;
			//let vals = Object.assign({}, getSelected);
			if(produto.qnt>=2)produto.qnt =produto.qnt / 2;
			//tabsDeCarrinho.insertItem(vals);
			//return false;
			//dados.val=getSelected.cod;
		}


		if(dados.type=="cod"){


			if(dados.val.substr(0, 1)==2){

				produto.cod = getCodTimer();
				produto.preco = (dados.val.substr(-8,7)/100).toFixed(2);
				produto.produto = 'Produto de Balança';
				produto.type = 'balanca';

				if(produto.preco=='0.00'){
					produto.preco = prompt("Qual é o Preço do Produto?").replace(",", ".");
				}

				}else{

					let server = getJSON('server.php?json=produtos&cod='+dados.val)['rows'][0];

					if(server){

						produto = server;
						produto.type = 'db';

					}else{

						dialogCadastroRapido({
							focus:'[name="produto"]',
							valuesInput:{cod:dados.val},
							onOpen:function(){
								desativaTeclas();
								googleSearch(dados.val,function(dados){
									$('[name="produto"]').val(dados.items[0].title);
									$('[name="preco"]').focus();
								})						
							},
				            onSendProdudo:function(saveData){
				            	saveData.name=saveData.produto;
				            	tabsDeCarrinho.insertItem(saveData);
				            },
							onClose:function(){
								ativaTeclasPDV();
							}
						});
					}
				}

		}



		if(dados.type=="money"){
			produto.type = dados.type;
			produto.preco = dados.val;
			produto.produto = 'Produto Avulso';
			produto.cod = getCodTimer();
		}

		if(dados.type=="negative"){
			produto.type = dados.type;
			produto.preco = dados.val;
			produto.produto = 'Pagamento';
			produto.cod = getCodTimer();
		}
		
		if(dados.type=="limpo"){

			//if(tabsDeCarrinho.getItemSelected());

			tabsDeCarrinho.insertItem(tabsDeCarrinho.getItemSelected())
			//produto = carrinhos.getselectProduto();
		}		

		if(produto.cod){
			
			//Adiciona Produto no Crrinho
			//---------------------------------------------------------------------//

			produto.name = produto.produto; 
			tabsDeCarrinho.insertItem(produto);
			//carrinhos.setCarrinho(produto);
			//window.listSelected = `#list_${carrinhos.selected}`;
			//$(window.listSelected).datagrid('selectRow',0);	

		}
	}		
})



</script>